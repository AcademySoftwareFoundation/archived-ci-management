---
- project:
    name: 3rdparty-boost-vfx2018
    3rdparty: boost
    jobs:
      - '3rdparty-{3rdparty}-stage-{stream}'
    project: ci-management
    project-name: ci-management
    build-node: ubuntu1604-builder-docker-2c-2g
    stream: vfx2018

- project:
    name: 3rdparty-tbb-vfx2018
    3rdparty: tbb
    jobs:
      - '3rdparty-{3rdparty}-stage-{stream}'
    project: ci-management
    project-name: ci-management
    build-node: ubuntu1604-builder-docker-2c-2g
    stream: vfx2018

- project:
    name: 3rdparty-ilmbase-vfx2018
    3rdparty: ilmbase
    jobs:
      - '3rdparty-{3rdparty}-stage-{stream}'
    project: ci-management
    project-name: ci-management
    build-node: ubuntu1604-builder-docker-2c-2g
    stream: vfx2018

- project:
    name: 3rdparty-openexr-vfx2018
    3rdparty: openexr
    jobs:
      - '3rdparty-{3rdparty}-stage-{stream}'
    project: ci-management
    project-name: ci-management
    build-node: ubuntu1604-builder-docker-2c-2g
    stream: vfx2018

- project:
    name: 3rdparty-pyilmbase-vfx2018
    3rdparty: pyilmbase
    jobs:
      - '3rdparty-{3rdparty}-stage-{stream}'
    project: ci-management
    project-name: ci-management
    build-node: ubuntu1604-builder-docker-2c-2g
    stream: vfx2018

- job-template:
    name: '3rdparty-{3rdparty}-stage-{stream}'

    ######################
    # Default parameters #
    ######################

    branch: master
    build-days-to-keep: 7
    build-dir: '$WORKSPACE/target'
    build-timeout: 60
    cmake-opts: ''
    install-prefix: '$BUILD_DIR/output'
    make-opts: ''
    pre-build: ''
    stream: master
    submodule-recursive: true
    submodule-timeout: 10
    project: ci-management
    project-name: ci-management

    # github_included_regions MUST match gerrit_trigger_file_paths
    github_included_regions:
      - '.*'

    #####################
    # Job Configuration #
    #####################

    project-type: freestyle
    node: '{build-node}'
    concurrent: true

    properties:
      - lf-infra-properties:
          build-days-to-keep: '{build-days-to-keep}'
      - github:
          url: '{git-url}/{github-org}/{project}'

    scm:
      - lf-infra-github-scm:
          url: '{git-clone-url}{github-org}/{project}'
          refspec: >
              +refs/heads/*:refs/remotes/origin/*
              +refs/pull/*:refs/remotes/origin/pr/*
          branch: '$GERRIT_REFSPEC'
          submodule-recursive: '{submodule-recursive}'
          submodule-timeout: '{submodule-timeout}'
          choosing-strategy: default
          jenkins-ssh-credential: '{jenkins-ssh-credential}'

    parameters:
      - lf-infra-parameters:
          project: '{project}'
          branch: '{branch}'
          stream: '{stream}'
          lftools-version: '{lftools-version}'
      - lf-cmake-parameters:
          build-dir: '{build-dir}'
          cmake-opts: '{cmake-opts}'
          install-prefix: '{install-prefix}'
          make-opts: '{make-opts}'

    wrappers:
      - lf-infra-wrappers:
          build-timeout: '{build-timeout}'
          jenkins-ssh-credential: '{jenkins-ssh-credential}'

    builders:
      - shell: 'pip install --user lftools'
      - shell: !include-raw-escape: boost/download.sh
      - shell: 'cd jjb/3rdparty/{3rdparty} && docker build -t {3rdparty}-builder .'
      - shell: 'mkdir -p $WORKSPACE/dist'
      - shell: 'docker run --name {3rdparty}-builder --rm -v $WORKSPACE/dist:/mnt/dist {3rdparty}-builder'
    publishers:
      - lf-infra-publish
